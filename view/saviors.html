<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Saviors</title>
        <link type="text/css" rel="stylesheet" href="style/saviors.css" />
        <link type="text/css" rel="stylesheet" href="style/tooltip.css" />
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
        <script src="js/jersey.js"></script>
    </head>
    <body>
		
		<div id="chart"></div>
		<div id="jerseys"></div>

        <script type="text/javascript">

            d3.json("../data/saviors.json", function(teams) {

            	//FIGURE OUT HOW TO MAKE THIS VISIBLE FROM JERSEY.JS
	            var colors= {"ATL":"#D21033", "BOS":"#05854C", "BRK":"#000000", "CHA":"#25799A", "CHI":"#D4001F", 
	            			 "CLE":"#9F1425", "DAL":"#006AB5", "DEN":"#4393D1", "DET":"#006BB6", "GSW":"#FFC33C", 
	            			 "HOU":"#CC0000", "IND":"#FFC225", "LAC":"#EE2944", "LAL":"#4A2583", "MEM":"#85A2C6", 
	            			 "MIA":"#B62630", "MIL":"#00330A", "MIN":"#12397F", "NOP":"#091D4A", "NYK":"#2E66B2", 
	            			 "OKC":"#0075C1", "ORL":"#077ABD", "PHI":"#C7974D", "PHO":"#FF7A31", "POR":"#E1393E", 
	            			 "SAC":"#743389", "SAS":"#BEC8C9", "TOR":"#CD1041", "UTA":"#448CCE", "WAS":"#004874", 
	            			 "SEA":"#006031", "WSB":"#CC3300", "STL":"#C41E3A", "PHW":"#FFCC00", "SYR":"#030066", 
	            			 "MNL":"#6495ED"}

            	var totalTeams= teams.length;
            	var w= 800;
            	var h= 350;
            	var navH= 200;

            	var margin = {top: 100, right: 20, bottom: 20, left:80}

            	/*~~~~~~~~   OVERARCHING SVG   ~~~~~~~~~~*/
            	var chartsSVG= d3.select("#chart")
            					.append("svg")
            					.attr("width",w)
            					.attr("height",h+navH)


				/*~~~~~~~~   MAIN CHART   ~~~~~~~~~~*/

				var extrema= {'max':{'mins':100,'ws':100,'count':8}, 'min':{'mins':0,'ws':0,'count':0}}
				var numerator= {'mins':'saviorMins','ws':'saviorWS','count':'totalSavs'}
				var denominator= {'mins':'totalMins','ws':'totalWins','count':1}
				var defaultMetric= "mins";
				var yLabelText= {'mins':'Minutes %','ws':'Win Share %','count':"# Saviors with "+minSaviorMPG+"+ mpg"}


				var main= {'w':w-margin.left-margin.right, 'h':h-margin.top-margin.bottom, 'x0':1952, 'xAxisLoc':0, 'xN':2015, 'y0':0, 'yAxisLoc':1952, 'yN':100, 't':5, 'xTitle':50, 'yTitle':50}


				//metric is mins, ws, or count
				function setGraph(metric) {
					//set main's boundaries appropriately
					main['y0']= extrema['min'][metric]
					main['xAxisLoc']= extrema['min'][metric]
					main['yN']= extrema['max'][metric]

					//redefine main yScale and yAxis
					yScale.domain([main['y0'], main['yN']])

					yAxis.scale(yScale)
							.ticks(main['t'])
							.orient("left")
							.tickFormat(d3.format("d"));

					//console.log("g",yAxis.scale().ticks(main['t']),yScale(yAxis.scale().ticks(main['t'])[2]))

					//Adjust chart background rect
					d3.select("#backgroundRect")
						  .attr("y", yScale(main['yN']))

					//reset horizontal line dividers on chart background
					horizontals.selectAll("line")
							.data(yAxis.scale().ticks(main['t'])) //a line corresp. to every tick
							.attr("x1", xScale(main['x0']))
							.attr("x2", xScale(main['xN']))
							.attr("y1",function(d) {
								return yScale(d);
							})
							.attr("y2",function(d) {
								return yScale(d);
							})

					//Drawing the axes
					chart.select("g#xAxis")
							.attr("transform", "translate("+0+"," + yScale(main['xAxisLoc']) + ")")
							.call(xAxis);
					chart.select("g#yAxis")
							.attr("transform", "translate("+ xScale(main['yAxisLoc']) +"," + 0 + ")")
							.call(yAxis);	

					//Rewriting yAxis label
					yLabel.text(yLabelText[metric])		

					//adjust bar heights
					d3.selectAll("rect.mainBar")
						.transition().delay(100)
						.attr("y",function(d){
							x= metric=='count' ? savsWithEnoughMins(d['saviors']).length/100 : d[numerator[metric]]/d[denominator[metric]]
                            return yScale(100*x);
                        })
						.attr("height",function(d){
							x= metric=='count' ? savsWithEnoughMins(d['saviors']).length/100 : d[numerator[metric]]/d[denominator[metric]]
                            return yScale(0)-yScale(100*x);
                        })

					//redefine nav yScale
					navYScale.domain([main['y0'], main['yN']])

					//reset nav chart fill and line and redraw them
					navFill.y1(function (d) {
						x= metric=='count' ? savsWithEnoughMins(d['saviors']).length/100 : d[numerator[metric]]/d[denominator[metric]]
						return navYScale(100*x); 
					});
					navLine.y(function (d) { 
						x= metric=='count' ? savsWithEnoughMins(d['saviors']).length/100 : d[numerator[metric]]/d[denominator[metric]]
						return navYScale(100*x); 
					});

					navChart.select('path.fill')
							.transition().delay(100)
				    		.attr('d', navFill(teams));
					navChart.select('path.line')
					    	.transition().delay(100)
					    	.attr('d', navLine(teams));

				}

				

				//Create SVG element
				var chart= chartsSVG.append("svg")
							.attr("width",main['w']+margin.left+margin.right)
							.attr("height",main['h']+margin.top+margin.bottom)    
							.append('g')
    						.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

				//Defining the scales
				var xScale = d3.scale.linear()
								.domain([main['x0'], main['xN']])
								.range([0, main['w']]);		 
				var yScale = d3.scale.linear()
									.domain([main['y0'], main['yN']])
									.range([main['h'],0]);

				
				var chartArea = chart.append('g')
					    .attr('clip-path', 'url(#chartAreaClip)');

				chartArea.append('clipPath')
				    .attr('id', 'chartAreaClip')
				    .append('rect')
				    .attr({ width: main['w'], height: main['h'] });            
	  			
	  			//Drawing rect on chart for backgroud color
				chartArea.append("rect")
						  .attr("id","backgroundRect")
						  .attr("x", xScale(main['yAxisLoc']))
						  .attr("y", yScale(main['yN']))
						  .attr("width","100%")
						  .attr("height","100%")

				var xAxis = d3.svg.axis()
								.scale(xScale)
								.ticks(main['t'])
								.orient("bottom")
								.tickFormat(d3.format("d"));
				var yAxis = d3.svg.axis()
								.scale(yScale)
								.ticks(main['t'])
								.orient("left")
								.tickFormat(d3.format("d"));

				//Drawing lines on graph
				lines= chartArea.append("g")
								.attr("id","lines")

				horizontals= lines.append("g")
									.attr("id","horizonalLines")
				horizontals.selectAll("line")
							.data(yAxis.scale().ticks(main['t'])) //a line corresp. to every tick
							.enter()
							.append("line")
							.attr("x1", xScale(main['x0']))
							.attr("x2", xScale(main['xN']))
							.attr("y1",function(d) {
								return yScale(d);
							})
							.attr("y2",function(d) {
								return yScale(d);
							})
	  
				//Drawing the axes
				chart.append("g")
						.attr("class", "axis")
						.attr("id","xAxis")
						.attr("transform", "translate("+0+"," + yScale(main['xAxisLoc']) + ")")
						.call(xAxis);
				chart.append("g")
						.attr("class", "axis")
						.attr("id","yAxis")
						.attr("transform", "translate("+ xScale(main['yAxisLoc']) +"," + 0 + ")")
						.call(yAxis);	

				//Writing title and axis labels
				var titleSize= margin.top/4
				var axisLabelSize= margin.left/5
				var title= chartsSVG.append("text")
								  .attr("class","label")
								  .attr("id","title")
								  .attr("x",margin.left+main["w"]/2)
								  .attr("y",margin.top/1.5)
								  .attr("font-size",titleSize)
								  .attr("text-anchor","middle")
								  .attr("dominant-baseline","central")
								  .text("Savior Playoff Contribution")
				var xLabel= chartsSVG.append("text")
								  .attr("class","label")
								  .attr("id","title")
								  .attr("x",margin.left+main["w"]/2)
								  .attr("y",h+navH - margin.bottom)
								  .attr("font-size",axisLabelSize)
								  .attr("text-anchor","middle")
								  .attr("dominant-baseline","bottom")
								  .text("Year")
				var yLabel= chartsSVG.append("text")
								  .attr("class","label")
								  .attr("id","title")
								  .attr("x",margin.left/2.5)
								  .attr("y",margin.top+main["h"]/2)
								  .attr("font-size",axisLabelSize)
								  .attr("text-anchor","middle")
								  .attr("dominant-baseline","central")
								  .attr("transform","rotate(-90 "+(margin.left/2.5)+","+(margin.top+main["h"]/2)+")")
								  .text("Playoff Minute %")
						

				//Tooltop for bars
				var tip = d3.tip()
						  .attr('class', 'd3-tip')
						  .offset([-10, 0])
						  .html(function(d,i) {
						    return "<p>" + (i+main['x0']) + " " + d.team + "</p> <p>Savior playoff mins %: <span style='color:red'>" + parseFloat(Math.round((100*d.saviorMins/d.totalMins)*10)/10).toFixed(1) + "</span></p> <p>Savior win share %: <span style='color:red'>" + parseFloat(Math.min(100,Math.round((100*d.saviorWS/d.totalWins)*10)/10)).toFixed(1) + "</span></p> <p> Click to see " + d.team+ "\'s <span style='color:red'>" + d["saviors"].length + "</span> saviors</p>";
						  })
				chart.call(tip)
						
				var numer= numerator[defaultMetric]
				var denom= denominator[defaultMetric]

				var barWidth= main['w']/(totalTeams+2)
				var bars= chartArea.selectAll("rect.mainBar")
							.data(teams)
							.enter()
							.append("rect")
							.attr("class","mainBar")
							.attr("x",function(d,i){
	                                return xScale(i+main['x0'])-barWidth/2;
	                            })
	                        .attr("y",function(d){
	                                return yScale(100*d[numer]/d[denom]);
	                            })
	                        .attr("width", barWidth)
	                        .attr("height",function(d){
	                                return yScale(0)-yScale(100*d[numer]/d[denom]);
	                            })
	                        .attr("fill",function(d) {
	                        	if (d["team"] in colors) {
	                        		return colors[d["team"]];
	                        	}
	                        	else {
	                        		return "grey";
	                        	}
	                        })
	                        .on('click',function(d,i) {
      							collectJerseys(jerseySVG,jersSVG_w,jersSVG_h,d["team"],d["year"],d["totalWins"],d["saviors"]) 
      						})
	                        .on('mouseover', tip.show)
      						.on('mouseout', tip.hide)


				
				/*~~~~~~~~   TOGGLE BUTTONS   ~~~~~~~~~~*/
				var toggleGroup= chartArea.append("g")
										.attr("id","toggle")

				var defaultColor= "#AAAAAA"
				var hoverColor= "#0000ff"
				var pressedColor= "#000077"

				var buttons= toggleGroup.selectAll("g.button")
										.data(Object.keys(numerator))
										.enter()
										.append("g")
										.attr("class","button")
										.attr("id",function(d){return d;})
										.style("cursor","pointer")
										.on("click",function(d) {
											setGraph(d); 
											updateButtonColors(d3.select(this), d3.select(this.parentNode))
											if(!viewport.empty()) {
												chart.select("g#yAxis")
													.attr("transform", "transform", "translate("+ xScale(viewport.extent()[0]) +"," + 0 + ")");
											}
										})
										.on("mouseover", function() {
											if (d3.select(this).select("rect").attr("fill") != pressedColor) {
												d3.select(this)
													.select("rect")
													.attr("fill",hoverColor);
											}
										})
										.on("mouseout", function() {
											if (d3.select(this).select("rect").attr("fill") != pressedColor) {
												d3.select(this)
													.select("rect")
													.attr("fill",defaultColor);
											}
										})

				function updateButtonColors(button, parent) {
					parent.selectAll("rect")
							.attr("fill",defaultColor)

					button.select("rect")
							.attr("fill",pressedColor)
				}

				var buttonRects= buttons.append("rect")
										.attr("height",25)
										.attr("width",40)
										.attr("x",function(d,i) {
											return main["w"] - 5 - (Object.keys(numerator).length - i)*45;
										})
										.attr("y",10)
										.attr("rx",5)
										.attr("ry",5)
										.attr("fill",defaultColor)

				//press mins button by default (or whatever I choose the default metric to be)
				toggleGroup.select("g#"+defaultMetric)
							.select("rect")
							.attr("fill",pressedColor)


				var icons= {"mins":"\uf017","ws":"\uf200","count":"\uf183"}

				var buttonsText= buttons.append("text")
											.attr("font-family","FontAwesome")
											.attr("x",function(d,i) {
												return main["w"] - 5 - (Object.keys(numerator).length - i)*45 + 20;
											})
											.attr("y",10+12.5)
											.attr("text-anchor","middle")
											.attr("dominant-baseline","central")
											.attr("fill","white")
											.text(function(d) {
												return icons[d];
											})




				/*~~~~~~~~   LOWER CHART   ~~~~~~~~~~*/
				var navMargin = {top: 15, right: 20, bottom: 75, left: 80}
				var navBarWidth= 20
				var nav= {'w':w-navMargin.left-navMargin.right, 'h':navH-navMargin.top-navMargin.bottom, 't':15}


				var navChart= chartsSVG.append("svg") 
								.attr("class","nav")
								.attr("width",nav['w']+navMargin.left+navMargin.right)
								.attr("height",nav['h']+navMargin.top+navMargin.bottom)    
								.attr("y",h)
								.append('g')
	    						.attr('transform', 'translate(' + navMargin.left + ',' + navMargin.top + ')');

				var navXScale = d3.scale.linear()
				        		.domain([main['x0'], main['xN']])
								.range([0, nav['w']]);	
				var navYScale = d3.scale.linear()
				        		.domain([main['y0'], main['yN']])
								.range([nav['h'],navMargin.top]);

				var navXAxis = d3.svg.axis()
							    .scale(navXScale)
							    .ticks(nav['t'])
							    .orient('bottom')
								.tickFormat(d3.format("d"));

				navChart.append('g')
				    .attr('class', 'x axis')
				    .attr('transform', 'translate(0,' + nav['h'] + ')')
				    .call(navXAxis);

				var navFill = d3.svg.area()
				    .x(function (d,i) { return navXScale(i+main['x0']); })
				    .y0(nav['h'])
				    .y1(function (d) { return navYScale(100*d[numer]/d[denom]); });

				var navLine = d3.svg.line()
				    .x(function (d,i) { return navXScale(i+main['x0']); })
				    .y(function (d) { return navYScale(100*d[numer]/d[denom]); });

				navChart.append('path')
				    .attr('class', 'fill')
				    .attr('d', navFill(teams));

				navChart.append('path')
				    .attr('class', 'line')
				    .attr('d', navLine(teams));

				setGraph(defaultMetric);

				/*~~~~~~~~   VIEW PORT   ~~~~~~~~~~*/          
				var viewport = d3.svg.brush()
				    .x(navXScale)
				    .on("brush", function () {
				        xScale.domain(viewport.empty() ? navXScale.domain() : viewport.extent());
				        chart.select("g#yAxis")
								.attr("transform", function() {
									if(viewport.empty()) {
										return "translate("+ xScale(main['yAxisLoc']) +"," + 0 + ")";
									}
									else {
										return "transform", "translate("+ xScale(viewport.extent()[0]) +"," + 0 + ")";
									}
								});
				        chart.selectAll("rect.mainBar")
					        .attr("width", function() {
					        	if(viewport.empty()) {
					        		return main['w']/(totalTeams+2);
					        	}
					        	else {
					        		return main['w']/(viewport.extent()[1]-viewport.extent()[0]+1);
					        	}
					        })
					        .attr("x", function(d,i) { 
					        	return xScale(i+main['x0'])-d3.select(this).attr("width")/2;
					        })
    					chart.select('#xAxis').call(xAxis);
				    });

			    navChart.append("g")
						.attr("class", "viewport")
						.call(viewport)
						.selectAll("rect")
						.attr("height", nav['h'])
						.attr("fill","purple")
						.attr("opacity",0.5)


				/*~~~~~~~~   JERSEYS   ~~~~~~~~~~*/

				//Create SVG element
				var jersSVG_w= 400;
				var jersSVG_h= h+navH-margin.top;

				var jerseySVG= d3.select("div#jerseys")
								.append("svg")
								.attr("width",jersSVG_w)
								.attr("height",jersSVG_h)    
								.attr("y",margin.top)

				var container= jerseySVG.append("rect")
									.attr('width',"100%")
									.attr('height',"100%")
									.attr('fill',"#cceedd")
									.attr('stroke',"#AAAAAA")
									.attr('stroke-width',4)

				//team name
				var jersTitle= jerseySVG.append("text")
										.attr("id","jersTitle")
										.attr("x",jersSVG_w/2)
										.attr("text-anchor","middle")
										.attr("y",tTop)
										.attr("dominant-baseline","hanging")
										.attr("font-size",t)
										.text("Saviors")
				
				//# playoff games chosen team won
				jerseySVG.append("text")
						.attr("id","gamesWon")
						.attr("x",jersSVG_w/2)
						.attr("text-anchor","middle")
						.attr("y",tTop+t+tBot)
						.attr("dominant-baseline","hanging")
						.attr("font-size",tSub)
						.text("Playoff games won: 0")

				//subtitle for saviors that played too few minutes
				jerseySVG.append("text")
						.attr("id","subtitle")
						.attr("opacity",0)
						.attr("x",jersSVG_w/2)
						.attr("text-anchor","middle")
						.attr("dominant-baseline","hanging")
						.attr("font-size",sub)
						.attr("fill","#888888")
						.text("--- Saviors below this line played < " + minSaviorMPG + " mins per playoff game ---")

            });
        </script>
    </body>
</html>